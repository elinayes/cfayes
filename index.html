<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFA 刷题系统</title>
    <style>
        :root {
            --bg-color: #f5f0ed;
            --card-bg: #ffffff;
            --primary-color: #b8a9a0;
            --primary-hover: #a89589;
            --text-main: #5d5652;
            --text-light: #8a817c;
            --border-color: #e2d9d5;
            --accent-bg: #faf7f5;
            --correct-color: #9aae9e;
            --wrong-color: #c9a5a5;
            --tag-bg: #e8e2de;
            --sage-green: #a8b5a0;
            --dusty-rose: #c9b3b3;
            --slate-blue: #9aa8b5;
            --warm-taupe: #bab0a8;
            --muted-gold: #c4b896;
            --star-color: #d4b896;
        }

        [data-theme="dark"] {
            --bg-color: #2a2725;
            --card-bg: #363230;
            --primary-color: #a89080;
            --primary-hover: #b9a090;
            --text-main: #d5d0cc;
            --text-light: #9a9590;
            --border-color: #4a4542;
            --accent-bg: #3a3533;
            --correct-color: #8a9e8d;
            --wrong-color: #b89090;
            --tag-bg: #454038;
            --star-color: #c4a880;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 15px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container { 
            background: var(--card-bg); 
            padding: 35px; 
            border-radius: 16px; 
            box-shadow: 0 8px 32px rgba(139, 125, 115, 0.12); 
            width: 100%;
            max-width: 1200px;
            min-height: 85vh;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: background-color 0.3s;
        }

        .scroll-content {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 8px;
            padding-bottom: 15px;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-color); }

        h1, h2, h3 { 
            text-align: center; 
            color: var(--text-main); 
            font-weight: 500; 
            margin-top: 0;
            letter-spacing: 0.5px;
        }

        h1 { font-size: 1.8em; }
        h2 { font-size: 1.4em; }
        h3 { font-size: 1.1em; }

        input[type="text"], input[type="password"], textarea { 
            width: 100%; 
            padding: 14px 16px; 
            border: 1.5px solid var(--border-color); 
            border-radius: 10px; 
            font-family: inherit; 
            resize: none; 
            background: var(--accent-bg); 
            outline: none;
            color: var(--text-main);
            font-size: 15px;
            transition: border-color 0.2s, background-color 0.3s;
        }
        input[type="text"]:focus, input[type="password"]:focus, textarea:focus { border-color: var(--primary-color); }
        textarea { height: 180px; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; }

        select {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid var(--border-color);
            border-radius: 10px;
            background: var(--accent-bg);
            color: var(--text-main);
            font-size: 15px;
            cursor: pointer;
            outline: none;
        }
        select:focus { border-color: var(--primary-color); }

        button { 
            display: inline-block; 
            padding: 11px 22px; 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 500;
            transition: all 0.2s ease; 
            white-space: nowrap;
        }
        button:hover { 
            background-color: var(--primary-hover); 
            transform: translateY(-1px); 
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        button.secondary { 
            background-color: var(--tag-bg); 
            color: var(--text-main); 
        }
        button.secondary:hover { background-color: var(--border-color); }
        
        button.danger { 
            background-color: #e5d5d5; 
            color: #8a6b6b; 
        }
        button.danger:hover { background-color: #dcc8c8; }

        button.success {
            background-color: var(--sage-green);
            color: white;
        }
        button.success:hover { background-color: #8fa08a; }

        button.small { padding: 7px 14px; font-size: 13px; }

        .hidden { display: none !important; }
        .center-box { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100%; 
        }

        .top-toolbar {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--text-light);
            transition: all 0.2s;
            padding: 0;
        }
        .icon-btn:hover {
            background: var(--tag-bg);
            color: var(--text-main);
        }
        .icon-btn.synced {
            color: var(--correct-color);
            border-color: var(--correct-color);
        }
        .icon-btn.syncing {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sync-status {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 12px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border-color);
        }

        .sync-dot.connected { background: var(--correct-color); }
        .sync-dot.syncing { background: var(--muted-gold); animation: pulse 1s infinite; }

        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1.5px solid var(--border-color);
            margin-bottom: 20px;
            flex-shrink: 0;
            gap: 15px;
        }

        .nav-bar h2, .nav-bar h3 { margin: 0; }

        .main-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 25px;
            border-bottom: 1.5px solid var(--border-color);
            padding-bottom: 15px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 24px;
            background: var(--accent-bg);
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: var(--tag-bg);
            color: var(--text-main);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .tag-section { margin-bottom: 20px; }

        .tag-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .tag-header span { font-size: 13px; color: var(--text-light); }

        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; }

        .tag {
            padding: 5px 12px;
            background: var(--tag-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            font-size: 12px;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag:hover { background: var(--border-color); }
        .tag.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        .tag.tag-npv { border-left: 3px solid var(--sage-green); }
        .tag.tag-capm { border-left: 3px solid var(--slate-blue); }
        .tag.tag-bond { border-left: 3px solid var(--warm-taupe); }
        .tag.tag-derivative { border-left: 3px solid var(--muted-gold); }
        .tag.tag-ethics { border-left: 3px solid #a8c4a8; }
        .tag.tag-fsa { border-left: 3px solid #b5a8c4; }
        .tag.tag-portfolio { border-left: 3px solid #c4b0a8; }
        .tag.tag-equity { border-left: 3px solid #a8b8c4; }

        .question-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .question-tag { padding: 3px 8px; background: var(--accent-bg); border-radius: 10px; font-size: 11px; color: var(--text-light); }

        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 18px;
            padding: 5px;
        }

        .book-card {
            background: var(--accent-bg);
            border: 1.5px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all 0.25s;
            position: relative;
            min-height: 150px;
        }
        .book-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(139, 125, 115, 0.15);
        }
        .book-card.quiz-bank { border-left: 4px solid var(--sage-green); }
        
        .book-title { font-size: 1.1em; font-weight: 600; margin-bottom: 8px; color: var(--text-main); }
        .book-stats { font-size: 0.88em; color: var(--text-light); margin-bottom: 15px; line-height: 1.6; }
        .book-actions { display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap; }
        
        .empty-state { text-align: center; color: var(--text-light); margin-top: 60px; line-height: 1.8; }

        .option-label { 
            display: flex; 
            align-items: flex-start; 
            padding: 16px 20px; 
            border: 1.5px solid var(--border-color); 
            border-radius: 10px; 
            margin-bottom: 12px; 
            cursor: pointer; 
            transition: all 0.2s; 
            background: var(--card-bg);
            line-height: 1.5;
        }
        .option-label:hover { border-color: var(--primary-color); background-color: var(--accent-bg); }
        .option-label.selected { border-color: var(--primary-color); background-color: var(--accent-bg); font-weight: 500; }
        input[type="radio"] { accent-color: var(--primary-color); margin-right: 14px; margin-top: 3px; transform: scale(1.15); flex-shrink: 0; }

        .review-item {
            border: 1px solid var(--border-color); 
            border-radius: 10px;
            padding: 20px; 
            margin-bottom: 15px; 
            background: var(--card-bg);
            position: relative;
        }
        .review-item.starred { border-color: var(--star-color); background: linear-gradient(135deg, var(--card-bg) 0%, rgba(212, 184, 150, 0.08) 100%); }

        .dashboard-modes { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 18px; 
            margin-top: 25px;
            width: 100%;
            max-width: 500px;
        }
        .mode-card {
            background: var(--accent-bg); 
            border: 1.5px solid var(--border-color);
            border-radius: 12px; 
            padding: 25px; 
            text-align: center; 
            cursor: pointer;
            transition: all 0.25s;
        }
        .mode-card:hover { border-color: var(--primary-color); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(139, 125, 115, 0.12); }
        .mode-card h3 { margin-bottom: 8px; }
        .mode-card p { font-size: 0.88em; margin: 0; color: var(--text-light); line-height: 1.5; }

        .feedback-box { margin-top: 20px; padding: 18px; border-radius: 10px; display: none; text-align: center; line-height: 1.6; }
        .feedback-correct { background-color: #eef3ef; color: #5a6b5d; }
        .feedback-wrong { background-color: #f5eeee; color: #7a6262; }
        [data-theme="dark"] .feedback-correct { background-color: #3a4038; color: #a0b0a0; }
        [data-theme="dark"] .feedback-wrong { background-color: #453838; color: #c0a0a0; }

        .badge { padding: 8px 16px; background: var(--accent-bg); color: var(--text-light); border-radius: 6px; font-weight: 500; }

        #question-text { font-size: 1.2em; line-height: 1.7; margin-bottom: 15px; text-align: left; color: var(--text-main); }

        .timer { font-family: 'Consolas', monospace; font-size: 1.1em; color: var(--text-light); padding: 8px 16px; background: var(--accent-bg); border-radius: 6px; }

        .progress-bar-container { width: 100%; height: 6px; background: var(--border-color); border-radius: 3px; margin-bottom: 20px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary-color); border-radius: 3px; transition: width 0.3s ease; }

        .result-section { text-align: center; padding: 30px 0; }
        .result-score { font-size: 3em; font-weight: 300; color: var(--text-main); margin-bottom: 10px; }
        .result-label { font-size: 1.1em; color: var(--text-light); margin-bottom: 30px; }

        .stat-number { font-size: 2.2em; font-weight: 300; }
        .stat-number.wrong { color: var(--wrong-color); }
        .stat-number.correct { color: var(--correct-color); }
        .stat-label { font-size: 0.85em; color: var(--text-light); margin-top: 5px; }

        .btn-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }

        .search-box { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-box input { flex: 1; }

        .filter-info { padding: 10px 15px; background: var(--accent-bg); border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: var(--text-light); }

        .star-btn { position: absolute; top: 15px; right: 15px; width: 30px; height: 30px; border: none; background: transparent; cursor: pointer; font-size: 18px; color: var(--border-color); transition: all 0.2s; padding: 0; }
        .star-btn:hover { color: var(--star-color); transform: scale(1.1); }
        .star-btn.starred { color: var(--star-color); }

        .error-badge { display: inline-block; padding: 2px 8px; background: var(--wrong-color); color: white; border-radius: 10px; font-size: 11px; margin-left: 8px; }

        .note-section { margin-top: 12px; padding-top: 12px; border-top: 1px dashed var(--border-color); }
        .note-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; background: var(--accent-bg); color: var(--text-main); resize: none; height: 60px; }
        .note-display { font-size: 13px; color: var(--text-light); font-style: italic; padding: 8px 12px; background: var(--accent-bg); border-radius: 6px; line-height: 1.5; }

        .stats-panel { background: var(--accent-bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 15px; }
        .stat-card { text-align: center; padding: 15px; background: var(--card-bg); border-radius: 8px; }
        .stat-card .value { font-size: 1.8em; font-weight: 300; color: var(--text-main); }
        .stat-card .label { font-size: 12px; color: var(--text-light); margin-top: 5px; }

        .tag-stats { margin-top: 15px; }
        .tag-stat-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .tag-stat-row:last-child { border-bottom: none; }
        .tag-stat-name { flex: 1; font-size: 13px; }
        .tag-stat-bar { width: 100px; height: 6px; background: var(--border-color); border-radius: 3px; margin: 0 15px; overflow: hidden; }
        .tag-stat-fill { height: 100%; background: var(--wrong-color); border-radius: 3px; }
        .tag-stat-count { font-size: 12px; color: var(--text-light); width: 50px; text-align: right; }

        .checkbox-row { display: flex; align-items: center; gap: 10px; margin: 15px 0; }
        .checkbox-row input[type="checkbox"] { accent-color: var(--primary-color); transform: scale(1.2); }
        .checkbox-row label { font-size: 14px; color: var(--text-main); cursor: pointer; }

        .settings-section { background: var(--accent-bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .settings-section h3 { text-align: left; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 13px; color: var(--text-light); margin-bottom: 6px; }
        .input-with-btn { display: flex; gap: 10px; }
        .input-with-btn input { flex: 1; }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 12px 24px; background: var(--text-main); color: var(--card-bg); border-radius: 8px; font-size: 14px; z-index: 1000; animation: toastIn 0.3s ease; }
        .toast.success { background: var(--correct-color); color: white; }
        .toast.error { background: var(--wrong-color); color: white; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

        .merge-checkbox { position: absolute; top: 15px; left: 15px; }
        .merge-checkbox input { accent-color: var(--primary-color); transform: scale(1.3); }

        .backup-info { font-size: 12px; color: var(--text-light); text-align: center; margin-top: 10px; }

        .section-divider { border-top: 2px solid var(--border-color); margin: 30px 0 20px 0; padding-top: 20px; }
        .section-title { font-size: 14px; color: var(--text-light); margin-bottom: 15px; font-weight: 500; }

        .quiz-source-selector { margin-bottom: 25px; padding: 20px; background: var(--accent-bg); border-radius: 12px; }
        .quiz-source-selector h3 { text-align: left; margin-bottom: 15px; }

        @media (max-width: 600px) {
            .container { padding: 20px; }
            .dashboard-modes { grid-template-columns: 1fr; }
            .main-tabs { flex-wrap: wrap; }
            .nav-bar { flex-wrap: wrap; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .top-toolbar { top: 10px; right: 10px; }
            .sync-status { display: none; }
        }
    </style>
</head>
<body>

<div class="container">
    
    <div class="sync-status">
        <span class="sync-dot" id="sync-dot"></span>
        <span id="sync-text">本地模式</span>
    </div>

    <div class="top-toolbar">
        <button class="icon-btn" id="sync-btn" onclick="manualSync()" title="同步数据">S</button>
        <button class="icon-btn" onclick="toggleTheme()" title="切换主题">
            <span id="theme-icon">D</span>
        </button>
    </div>

    <!-- 主页面 -->
    <div id="view-main" style="display: flex; flex-direction: column; height: 100%;">
        <div class="main-tabs">
            <div class="tab-btn active" onclick="switchMainTab('quiz')">刷题</div>
            <div class="tab-btn" onclick="switchMainTab('banks')">题库</div>
            <div class="tab-btn" onclick="switchMainTab('library')">错题本</div>
            <div class="tab-btn" onclick="switchMainTab('stats')">统计</div>
            <div class="tab-btn" onclick="switchMainTab('settings')">设置</div>
        </div>

        <!-- 刷题模式 -->
        <div id="tab-quiz" class="scroll-content">
            <div style="max-width: 600px; margin: 0 auto;">
                <h2>开始刷题</h2>
                
                <!-- 从题库选择 -->
                <div class="quiz-source-selector">
                    <h3>从已保存题库选择</h3>
                    <select id="quiz-bank-select">
                        <option value="">-- 选择题库 --</option>
                    </select>
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="startQuizFromBank()">开始刷题</button>
                    </div>
                </div>

                <div class="section-divider">
                    <div class="section-title">或者直接粘贴 JSON</div>
                </div>

                <textarea id="quiz-json-input" placeholder='[{"question": "...", "options": [...], "answer": "..."}]'></textarea>
                
                <div class="checkbox-row">
                    <input type="checkbox" id="shuffle-checkbox" checked>
                    <label for="shuffle-checkbox">随机打乱题目顺序</label>
                </div>
                <div class="checkbox-row">
                    <input type="checkbox" id="timer-checkbox" checked>
                    <label for="timer-checkbox">启用计时器</label>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="startQuiz()">开始刷题</button>
                </div>
                <p id="quiz-error" style="color: var(--wrong-color); margin-top: 15px; text-align: center;"></p>
            </div>
        </div>

        <!-- 题库管理 -->
        <div id="tab-banks" class="scroll-content hidden">
            <div class="nav-bar" style="border-bottom: none; margin-bottom: 15px; padding-bottom: 0;">
                <span style="color: var(--text-light); font-size: 14px;">共 <span id="total-banks">0</span> 套题库</span>
                <button onclick="showAddBankView()">添加题库</button>
            </div>
            <div id="banks-container"></div>
        </div>

        <!-- 错题本 -->
        <div id="tab-library" class="scroll-content hidden">
            <div class="nav-bar" style="border-bottom: none; margin-bottom: 15px; padding-bottom: 0;">
                <span style="color: var(--text-light); font-size: 14px;">共 <span id="total-books">0</span> 本错题本</span>
                <div class="btn-group">
                    <button class="small secondary" id="merge-btn" onclick="toggleMergeMode()">合并模式</button>
                    <button onclick="showImportView()">新建错题本</button>
                </div>
            </div>

            <div class="search-box">
                <input type="text" id="search-input" placeholder="搜索题目内容..." oninput="handleSearch()">
                <button class="secondary" onclick="clearSearch()">清除</button>
            </div>

            <div class="tag-section" id="library-tag-section">
                <div class="tag-header">
                    <span>按标签筛选</span>
                    <button class="small secondary" onclick="clearTagFilter()">清除筛选</button>
                </div>
                <div class="tag-container" id="library-tags"></div>
            </div>

            <div id="filter-info" class="filter-info hidden">
                <span id="filter-text">筛选结果</span>
                <button class="small secondary" onclick="clearAllFilters()">清除</button>
            </div>

            <div id="merge-toolbar" class="hidden" style="margin-bottom: 15px; padding: 15px; background: var(--accent-bg); border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>已选择 <strong id="merge-count">0</strong> 个错题本</span>
                    <div class="btn-group">
                        <button class="small" onclick="executeMerge()">合并选中</button>
                        <button class="small secondary" onclick="cancelMerge()">取消</button>
                    </div>
                </div>
            </div>

            <div id="library-container"></div>
        </div>

        <!-- 统计面板 -->
        <div id="tab-stats" class="scroll-content hidden">
            <h2>学习统计</h2>
            
            <div class="stats-panel">
                <h3 style="margin-bottom: 0;">总览</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="value" id="stat-total-banks">0</div>
                        <div class="label">题库</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="stat-total-mistakes">0</div>
                        <div class="label">待攻克</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="stat-total-solved">0</div>
                        <div class="label">已斩杀</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="stat-total-starred">0</div>
                        <div class="label">已收藏</div>
                    </div>
                </div>
            </div>

            <div class="stats-panel">
                <h3 style="margin-bottom: 0;">标签分布</h3>
                <div class="tag-stats" id="tag-stats-container"></div>
            </div>

            <div class="stats-panel">
                <h3 style="margin-bottom: 0;">高频错题</h3>
                <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">错误次数最多的题目</p>
                <div id="frequent-mistakes-container"></div>
            </div>
        </div>

        <!-- 设置面板 -->
        <div id="tab-settings" class="scroll-content hidden">
            <h2>设置</h2>

            <div class="settings-section">
                <h3>云同步 (GitHub Gist)</h3>
                <p style="font-size: 13px; color: var(--text-light); margin-bottom: 20px; line-height: 1.6;">
                    使用 GitHub Gist 存储数据，实现多设备同步。题库和错题本都会同步。
                </p>
                
                <div class="input-group">
                    <label>GitHub Personal Access Token</label>
                    <div class="input-with-btn">
                        <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxx">
                        <button class="small secondary" onclick="toggleTokenVisibility()">显示</button>
                    </div>
                    <p style="font-size: 12px; color: var(--text-light); margin-top: 6px;">
                        需要 gist 权限。<a href="https://github.com/settings/tokens/new?scopes=gist&description=CFA%20Study%20Sync" target="_blank" style="color: var(--primary-color);">点击创建 Token</a>
                    </p>
                </div>

                <div class="input-group">
                    <label>Gist ID (首次同步后自动生成)</label>
                    <input type="text" id="gist-id" placeholder="首次上传会自动生成，或输入已有 Gist ID">
                </div>

                <div class="btn-group" style="justify-content: flex-start; margin-top: 20px;">
                    <button onclick="saveCloudConfig()">保存配置</button>
                    <button class="secondary" onclick="testConnection()">测试连接</button>
                    <button class="success" onclick="uploadToCloud()">上传到云端</button>
                    <button class="secondary" onclick="downloadFromCloud()">从云端下载</button>
                </div>

                <div id="cloud-status" class="backup-info"></div>
            </div>

            <div class="settings-section">
                <h3>本地备份</h3>
                <p style="font-size: 13px; color: var(--text-light); margin-bottom: 15px;">
                    导出/导入完整数据文件（包含题库和错题本）。
                </p>
                <div class="btn-group" style="justify-content: flex-start;">
                    <button class="secondary" onclick="exportAllData()">导出全部数据</button>
                    <button class="secondary" onclick="document.getElementById('import-file').click()">导入数据文件</button>
                    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importAllData(event)">
                </div>
            </div>

            <div class="settings-section">
                <h3>危险操作</h3>
                <div class="btn-group" style="justify-content: flex-start;">
                    <button class="danger" onclick="clearAllData()">清除所有本地数据</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加题库页面 -->
    <div id="view-add-bank" class="center-box hidden">
        <div style="width: 100%; max-width: 550px;">
            <h2>添加题库</h2>
            <p style="margin-bottom: 8px; color: var(--text-light);">题库名称</p>
            <input type="text" id="bank-name-input" placeholder="例如：CFA L1 Ethics Chapter 1">
            
            <p style="margin-bottom: 8px; margin-top: 20px; color: var(--text-light);">粘贴题目 JSON 数据</p>
            <textarea id="bank-json-input" placeholder='[{"question": "...", "options": [...], "answer": "..."}]'></textarea>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="saveNewBank()" style="flex: 2;">保存题库</button>
                <button class="secondary" onclick="backToMain()" style="flex: 1;">取消</button>
            </div>
            <p id="bank-error" style="color: var(--wrong-color); margin-top: 12px; text-align: center;"></p>
        </div>
    </div>

    <!-- 新建错题本页面 -->
    <div id="view-import" class="center-box hidden">
        <div style="width: 100%; max-width: 550px;">
            <h2>新建错题本</h2>
            <p style="margin-bottom: 8px; color: var(--text-light);">错题本名称</p>
            <input type="text" id="set-name-input" placeholder="例如：CFA L1 Ethics">
            
            <p style="margin-bottom: 8px; margin-top: 20px; color: var(--text-light);">粘贴错题 JSON 数据</p>
            <textarea id="import-json-input" placeholder='[{"question": "...", "options": [...], "answer": "..."}]'></textarea>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="saveNewBook()" style="flex: 2;">保存</button>
                <button class="secondary" onclick="backToMain()" style="flex: 1;">取消</button>
            </div>
            <p id="import-error" style="color: var(--wrong-color); margin-top: 12px; text-align: center;"></p>
        </div>
    </div>

    <!-- 刷题页面 -->
    <div id="view-quiz" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
        <div class="nav-bar">
            <button class="secondary" onclick="confirmExitQuiz()">退出</button>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span class="badge" id="quiz-progress"></span>
                <span class="badge">得分: <span id="quiz-score">0</span></span>
                <span class="timer" id="quiz-timer">00:00</span>
            </div>
        </div>
        
        <div class="progress-bar-container">
            <div class="progress-bar" id="quiz-progress-bar" style="width: 0%;"></div>
        </div>

        <div class="scroll-content" style="max-width: 800px; margin: 0 auto; width: 100%;">
            <div id="question-text"></div>
            <div id="question-tags-display" class="question-tags"></div>
            <div id="options-container" style="margin-top: 20px;"></div>
            <div id="quiz-feedback" class="feedback-box"></div>
            <div style="margin-top: 25px; text-align: center;">
                <button id="quiz-submit-btn" onclick="checkQuizAnswer()">确定</button>
                <button id="quiz-next-btn" class="hidden" onclick="nextQuizQuestion()">下一题</button>
            </div>
        </div>
    </div>

    <!-- 刷题结果页面 -->
    <div id="view-quiz-result" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
        <div class="scroll-content">
            <div class="result-section">
                <h2>刷题完成</h2>
                <div class="result-score"><span id="final-score">0</span> / <span id="final-total">0</span></div>
                <div class="result-label">
                    正确率: <span id="accuracy-rate">0</span>% | 
                    用时: <span id="total-time">00:00</span>
                </div>
                
                <div id="quiz-result-mistakes" class="hidden" style="margin-top: 30px; text-align: left;">
                    <h3 style="color: var(--wrong-color); text-align: center;">本次错题</h3>
                    <p style="text-align: center; color: var(--text-light); font-size: 14px; margin-bottom: 15px;">
                        错题已自动添加到错题本，下方 JSON 可复制用于讲解
                    </p>
                    <textarea id="quiz-mistake-json" readonly style="height: 250px;"></textarea>
                    <div class="btn-group" style="margin-top: 15px;">
                        <button class="secondary" onclick="copyQuizMistakes()">复制 JSON</button>
                    </div>
                </div>

                <div id="quiz-result-perfect" class="hidden" style="margin-top: 40px;">
                    <h3 style="color: var(--correct-color);">全部正确</h3>
                    <p style="color: var(--text-light);">太棒了，没有错题</p>
                </div>

                <div class="btn-group" style="margin-top: 30px;">
                    <button onclick="backToMain()">返回主页</button>
                    <button class="secondary" onclick="restartQuiz()">再做一次</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 错题本详情页 -->
    <div id="view-book" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
        <div class="nav-bar">
            <button class="secondary" onclick="backToMain()">返回</button>
            <h3 id="book-title-display" style="margin: 0;"></h3>
            <div style="width: 70px;"></div>
        </div>

        <div class="center-box" style="justify-content: flex-start; padding-top: 20px;">
            <div style="display: flex; gap: 40px; margin-bottom: 25px;">
                <div style="text-align: center;">
                    <div class="stat-number wrong" id="book-remaining">0</div>
                    <div class="stat-label">待攻克</div>
                </div>
                <div style="text-align: center;">
                    <div class="stat-number correct" id="book-solved">0</div>
                    <div class="stat-label">已斩杀</div>
                </div>
                <div style="text-align: center;">
                    <div class="stat-number" style="color: var(--star-color);" id="book-starred">0</div>
                    <div class="stat-label">已收藏</div>
                </div>
            </div>

            <div class="tag-section" style="width: 100%; max-width: 500px;">
                <div class="tag-header"><span>题目标签</span></div>
                <div class="tag-container" id="book-tags"></div>
            </div>

            <div class="dashboard-modes">
                <div class="mode-card" onclick="startRedo()">
                    <h3>错题重做</h3>
                    <p>做对自动移除<br>做错继续保留</p>
                </div>
                <div class="mode-card" onclick="startReview()">
                    <h3>错题回顾</h3>
                    <p>浏览模式<br>查看答案</p>
                </div>
                <div class="mode-card" onclick="startStarredReview()">
                    <h3>收藏回顾</h3>
                    <p>只看收藏的<br>重点题目</p>
                </div>
                <div class="mode-card" onclick="startRedoStarred()">
                    <h3>收藏重做</h3>
                    <p>重做收藏的<br>题目</p>
                </div>
            </div>

            <div style="margin-top: auto; padding: 20px 0;">
                <button class="small secondary" onclick="exportBook()">导出剩余错题</button>
            </div>
        </div>
    </div>

    <!-- 错题重做页面 -->
    <div id="view-redo" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
        <div class="nav-bar">
            <button class="secondary" onclick="backToBook()">暂停</button>
            <span style="color: var(--wrong-color); font-weight: 500;">剩余: <span id="redo-count"></span></span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="redo-progress-bar" style="width: 0%;"></div>
        </div>
        <div class="scroll-content" style="max-width: 800px; margin: 0 auto; width: 100%;">
            <div id="redo-content"></div>
            <div id="redo-feedback" class="feedback-box"></div>
            <div style="margin-top: 25px; text-align: center;">
                <button id="redo-submit-btn" onclick="checkRedo()">确定</button>
                <button id="redo-next-btn" class="hidden" onclick="nextRedo()">下一题</button>
            </div>
        </div>
    </div>

    <!-- 错题回顾页面 -->
    <div id="view-review" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
        <div class="nav-bar">
            <button class="secondary" onclick="backToBook()">返回</button>
            <span id="review-mode-title" style="color: var(--text-light);">回顾模式</span>
            <div style="width: 70px;"></div>
        </div>

        <div class="tag-section" style="padding: 0 5px;">
            <div class="tag-header">
                <span>按标签筛选</span>
                <button class="small secondary" onclick="clearReviewTagFilter()">清除筛选</button>
            </div>
            <div class="tag-container" id="review-tags"></div>
        </div>

        <div id="review-filter-info" class="filter-info hidden">
            <span id="review-filter-text">筛选结果</span>
        </div>

        <div id="review-list" class="scroll-content"></div>
    </div>

</div>

<script>
    // ========== CFA 标签系统 ==========
    const CFA_TAGS = {
        'NPV': ['npv', 'net present value'], 'IRR': ['irr', 'internal rate of return'],
        'CAPM': ['capm', 'capital asset pricing'], 'Beta': ['beta', 'systematic risk'],
        'Duration': ['duration', 'macaulay'], 'YTM': ['ytm', 'yield to maturity'],
        'Bond': ['bond', 'coupon', 'face value'], 'Option': ['option', 'call', 'put', 'strike'],
        'Forward': ['forward', 'futures'], 'Swap': ['swap'],
        'P/E': ['p/e', 'price earnings'], 'ROE': ['roe', 'return on equity'],
        'EPS': ['eps', 'earnings per share'], 'FSA': ['financial statement', 'balance sheet'],
        'Portfolio': ['portfolio', 'diversification'], 'Ethics': ['ethics', 'standard', 'code of conduct'],
        'GIPS': ['gips'], 'GDP': ['gdp'], 'Inflation': ['inflation', 'cpi'],
        'FX': ['exchange rate', 'currency', 'forex'], 'Regression': ['regression', 'r-squared'],
        'Hypothesis': ['hypothesis', 't-test', 'p-value']
    };

    function detectTags(question) {
        const tags = [];
        const text = (question.question + ' ' + question.options.join(' ')).toLowerCase();
        for (const [tag, keywords] of Object.entries(CFA_TAGS)) {
            for (const keyword of keywords) {
                if (text.includes(keyword.toLowerCase())) { tags.push(tag); break; }
            }
        }
        return [...new Set(tags)];
    }

    function addTagsToQuestions(questions) {
        return questions.map(q => ({
            ...q, tags: q.tags || detectTags(q), errorCount: q.errorCount || 0, starred: q.starred || false, note: q.note || ''
        }));
    }

    function getAllUsedTags(questions) {
        const tagSet = new Set();
        questions.forEach(q => (q.tags || []).forEach(t => tagSet.add(t)));
        return Array.from(tagSet).sort();
    }

    function getTagClass(tag) {
        const t = tag.toLowerCase();
        if (t.includes('npv') || t.includes('irr')) return 'tag-npv';
        if (t.includes('capm') || t.includes('beta')) return 'tag-capm';
        if (t.includes('bond') || t.includes('duration')) return 'tag-bond';
        if (t.includes('option') || t.includes('forward') || t.includes('swap')) return 'tag-derivative';
        if (t.includes('ethic') || t.includes('gips')) return 'tag-ethics';
        if (t.includes('fsa')) return 'tag-fsa';
        if (t.includes('portfolio')) return 'tag-portfolio';
        if (t.includes('roe') || t.includes('eps')) return 'tag-equity';
        return '';
    }

    // ========== 全局数据 ==========
    let banks = [];  // 题库
    let books = [];  // 错题本
    let currentBookId = null;
    let currentTagFilter = null;
    let reviewTagFilter = null;
    let searchQuery = '';
    let mergeMode = false;
    let selectedForMerge = new Set();
    let reviewMode = 'all';
    let redoMode = 'all';
    let redoOriginalCount = 0;
    
    let quizQuestions = [];
    let quizIndex = 0;
    let quizScore = 0;
    let quizMistakes = [];
    let quizAnswered = false;
    let lastQuizJSON = '';
    let currentQuizBankId = null;
    let timerEnabled = true;
    let timerInterval = null;
    let timerSeconds = 0;

    let darkMode = localStorage.getItem('cfa_dark_mode') === 'true';
    let cloudConfig = { token: '', gistId: '', lastSync: null };

    // ========== 初始化 ==========
    window.onload = function() {
        loadCloudConfig();
        loadDataFromStorage();
        renderBanks();
        renderLibrary();
        renderLibraryTags();
        renderBankSelect();
        applyTheme();
        updateSyncStatus();
    };

    // ========== Toast ==========
    function showToast(message, type = '') {
        const existing = document.querySelector('.toast');
        if (existing) existing.remove();
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // ========== 数据持久化 ==========
    function loadDataFromStorage() {
        const savedBanks = localStorage.getItem('cfa_banks_v1');
        const savedBooks = localStorage.getItem('cfa_books_v1');
        if (savedBanks) banks = JSON.parse(savedBanks);
        if (savedBooks) books = JSON.parse(savedBooks);
    }

    function saveDataToStorage() {
        localStorage.setItem('cfa_banks_v1', JSON.stringify(banks));
        localStorage.setItem('cfa_books_v1', JSON.stringify(books));
    }

    // ========== 云同步 ==========
    function loadCloudConfig() {
        const saved = localStorage.getItem('cfa_cloud_config');
        if (saved) {
            cloudConfig = JSON.parse(saved);
            document.getElementById('github-token').value = cloudConfig.token || '';
            document.getElementById('gist-id').value = cloudConfig.gistId || '';
        }
    }

    function saveCloudConfig() {
        cloudConfig.token = document.getElementById('github-token').value.trim();
        cloudConfig.gistId = document.getElementById('gist-id').value.trim();
        localStorage.setItem('cfa_cloud_config', JSON.stringify(cloudConfig));
        showToast('配置已保存', 'success');
        updateSyncStatus();
    }

    function updateSyncStatus() {
        const dot = document.getElementById('sync-dot');
        const text = document.getElementById('sync-text');
        const btn = document.getElementById('sync-btn');
        
        if (cloudConfig.token && cloudConfig.gistId) {
            dot.classList.add('connected'); text.textContent = '已连接'; btn.classList.add('synced');
        } else if (cloudConfig.token) {
            dot.classList.remove('connected'); text.textContent = '待配置'; btn.classList.remove('synced');
        } else {
            dot.classList.remove('connected'); text.textContent = '本地模式'; btn.classList.remove('synced');
        }
    }

    function toggleTokenVisibility() {
        const input = document.getElementById('github-token');
        input.type = input.type === 'password' ? 'text' : 'password';
    }

    async function testConnection() {
        const token = document.getElementById('github-token').value.trim();
        if (!token) { showToast('请先输入 Token', 'error'); return; }
        try {
            const response = await fetch('https://api.github.com/user', { headers: { 'Authorization': `token ${token}` } });
            if (response.ok) { const user = await response.json(); showToast(`连接成功: ${user.login}`, 'success'); }
            else showToast('Token 无效', 'error');
        } catch (e) { showToast('连接失败: ' + e.message, 'error'); }
    }

    async function uploadToCloud() {
        if (!cloudConfig.token) { showToast('请先配置 Token', 'error'); return; }
        const syncBtn = document.getElementById('sync-btn');
        const dot = document.getElementById('sync-dot');
        syncBtn.classList.add('syncing'); dot.classList.add('syncing');

        try {
            const data = { banks, books, exportTime: new Date().toISOString(), version: 3 };
            const content = JSON.stringify(data, null, 2);
            
            if (cloudConfig.gistId) {
                const response = await fetch(`https://api.github.com/gists/${cloudConfig.gistId}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `token ${cloudConfig.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ files: { 'cfa_study_data.json': { content } } })
                });
                if (!response.ok) throw new Error('更新失败');
                showToast('上传成功', 'success');
            } else {
                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: { 'Authorization': `token ${cloudConfig.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: 'CFA Study System Data', public: false, files: { 'cfa_study_data.json': { content } } })
                });
                if (!response.ok) throw new Error('创建失败');
                const gist = await response.json();
                cloudConfig.gistId = gist.id;
                document.getElementById('gist-id').value = gist.id;
                localStorage.setItem('cfa_cloud_config', JSON.stringify(cloudConfig));
                showToast('已创建新 Gist 并上传', 'success');
            }
            cloudConfig.lastSync = new Date().toISOString();
            localStorage.setItem('cfa_cloud_config', JSON.stringify(cloudConfig));
            updateCloudStatus();
        } catch (e) { showToast('上传失败: ' + e.message, 'error'); }
        finally { syncBtn.classList.remove('syncing'); dot.classList.remove('syncing'); updateSyncStatus(); }
    }

    async function downloadFromCloud() {
        if (!cloudConfig.token || !cloudConfig.gistId) { showToast('请先配置 Token 和 Gist ID', 'error'); return; }
        const syncBtn = document.getElementById('sync-btn');
        const dot = document.getElementById('sync-dot');
        syncBtn.classList.add('syncing'); dot.classList.add('syncing');

        try {
            const response = await fetch(`https://api.github.com/gists/${cloudConfig.gistId}`, { headers: { 'Authorization': `token ${cloudConfig.token}` } });
            if (!response.ok) throw new Error('获取失败');
            const gist = await response.json();
            const file = gist.files['cfa_study_data.json'];
            if (!file) throw new Error('数据文件不存在');
            const data = JSON.parse(file.content);
            
            if (data.banks) banks = data.banks;
            if (data.books) books = data.books;
            saveDataToStorage();
            renderBanks(); renderLibrary(); renderLibraryTags(); renderBankSelect();
            showToast(`已下载 ${banks.length} 套题库, ${books.length} 个错题本`, 'success');
            cloudConfig.lastSync = new Date().toISOString();
            localStorage.setItem('cfa_cloud_config', JSON.stringify(cloudConfig));
            updateCloudStatus();
        } catch (e) { showToast('下载失败: ' + e.message, 'error'); }
        finally { syncBtn.classList.remove('syncing'); dot.classList.remove('syncing'); }
    }

    async function manualSync() {
        if (!cloudConfig.token || !cloudConfig.gistId) { showToast('请先在设置中配置云同步', 'error'); switchMainTab('settings'); return; }
        await uploadToCloud();
    }

    function updateCloudStatus() {
        const status = document.getElementById('cloud-status');
        if (cloudConfig.lastSync) {
            const date = new Date(cloudConfig.lastSync);
            status.textContent = `上次同步: ${date.toLocaleString()}`;
        } else { status.textContent = ''; }
    }

    // ========== 本地备份 ==========
    function exportAllData() {
        const data = { banks, books, exportTime: new Date().toISOString(), version: 3 };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `cfa_study_backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click(); URL.revokeObjectURL(url);
        showToast('导出成功', 'success');
    }

    function importAllData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (confirm(`确定要导入数据吗？这将覆盖当前数据。`)) {
                    if (data.banks) banks = data.banks;
                    if (data.books) books = data.books;
                    saveDataToStorage();
                    renderBanks(); renderLibrary(); renderLibraryTags(); renderBankSelect();
                    showToast('导入成功', 'success');
                }
            } catch (err) { showToast('导入失败: ' + err.message, 'error'); }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    function clearAllData() {
        if (confirm('确定要清除所有本地数据吗？此操作不可恢复！')) {
            if (confirm('再次确认：这将删除所有题库和错题本！')) {
                banks = []; books = [];
                saveDataToStorage();
                renderBanks(); renderLibrary(); renderLibraryTags(); renderBankSelect();
                showToast('数据已清除', 'success');
            }
        }
    }

    // ========== 主题 ==========
    function toggleTheme() {
        darkMode = !darkMode;
        localStorage.setItem('cfa_dark_mode', darkMode);
        applyTheme();
    }

    function applyTheme() {
        document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
        document.getElementById('theme-icon').textContent = darkMode ? 'L' : 'D';
    }

    // ========== 计时器 ==========
    function startTimer() {
        if (!timerEnabled) { document.getElementById('quiz-timer').style.display = 'none'; return; }
        document.getElementById('quiz-timer').style.display = 'block';
        timerSeconds = 0; updateTimerDisplay();
        timerInterval = setInterval(() => { timerSeconds++; updateTimerDisplay(); }, 1000);
    }
    function stopTimer() { if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } }
    function updateTimerDisplay() {
        const mins = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
        const secs = (timerSeconds % 60).toString().padStart(2, '0');
        document.getElementById('quiz-timer').textContent = `${mins}:${secs}`;
    }
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        return `${mins}:${secs}`;
    }
    function shuffleArray(array) {
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; }
        return arr;
    }

    // ========== 页面切换 ==========
    function switchMainTab(tab) {
        const tabs = ['quiz', 'banks', 'library', 'stats', 'settings'];
        document.querySelectorAll('.main-tabs .tab-btn').forEach((btn, i) => btn.classList.toggle('active', tabs[i] === tab));
        tabs.forEach(t => document.getElementById(`tab-${t}`).classList.toggle('hidden', t !== tab));
        if (tab === 'banks') renderBanks();
        if (tab === 'library') { renderLibrary(); renderLibraryTags(); }
        if (tab === 'stats') renderStats();
        if (tab === 'settings') updateCloudStatus();
        if (tab === 'quiz') renderBankSelect();
    }

    function backToMain() {
        stopTimer(); hideAllViews();
        document.getElementById('view-main').style.display = 'flex';
        renderBanks(); renderLibrary(); renderLibraryTags(); renderBankSelect();
    }

    function hideAllViews() {
        ['view-main', 'view-add-bank', 'view-import', 'view-quiz', 'view-quiz-result', 'view-book', 'view-redo', 'view-review'].forEach(id => {
            document.getElementById(id).style.display = 'none';
            document.getElementById(id).classList.add('hidden');
        });
    }

    function showView(viewId) {
        hideAllViews();
        const el = document.getElementById(viewId);
        el.classList.remove('hidden'); el.style.display = 'flex';
    }

    // ========== 题库管理 ==========
    function renderBanks() {
        const container = document.getElementById('banks-container');
        document.getElementById('total-banks').textContent = banks.length;

        if (banks.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>还没有题库</p><p>点击右上角添加</p></div>';
            return;
        }

        const grid = document.createElement('div');
        grid.className = 'library-grid';

        banks.forEach(bank => {
            const card = document.createElement('div');
            card.className = 'book-card quiz-bank';
            const tags = getAllUsedTags(bank.questions).slice(0, 3);
            
            card.innerHTML = `
                <div>
                    <div class="book-title">${bank.name}</div>
                    <div class="book-stats">共 <strong>${bank.questions.length}</strong> 道题</div>
                    ${tags.length > 0 ? `<div class="question-tags">${tags.map(t => `<span class="question-tag">${t}</span>`).join('')}</div>` : ''}
                </div>
                <div class="book-actions">
                    <button class="small" onclick="startQuizFromBankId('${bank.id}')">刷题</button>
                    <button class="small secondary" onclick="exportBank('${bank.id}')">导出</button>
                    <button class="small danger" onclick="deleteBank('${bank.id}')">删除</button>
                </div>
            `;
            grid.appendChild(card);
        });
        container.innerHTML = '';
        container.appendChild(grid);
    }

    function renderBankSelect() {
        const select = document.getElementById('quiz-bank-select');
        select.innerHTML = '<option value="">-- 选择题库 --</option>';
        banks.forEach(bank => {
            const option = document.createElement('option');
            option.value = bank.id;
            option.textContent = `${bank.name} (${bank.questions.length} 题)`;
            select.appendChild(option);
        });
    }

    function showAddBankView() {
        document.getElementById('bank-name-input').value = '';
        document.getElementById('bank-json-input').value = '';
        document.getElementById('bank-error').textContent = '';
        showView('view-add-bank');
    }

    function saveNewBank() {
        const name = document.getElementById('bank-name-input').value.trim();
        const jsonStr = document.getElementById('bank-json-input').value;

        if (!name) { document.getElementById('bank-error').textContent = '请输入题库名称'; return; }

        try {
            let data = JSON.parse(jsonStr);
            if (!Array.isArray(data) || data.length === 0) throw new Error('必须是非空数组');
            if (!data[0].question || !data[0].answer) throw new Error('格式错误');
            
            data = addTagsToQuestions(data);
            banks.push({ id: Date.now().toString(), name, questions: data, createdAt: new Date().toISOString() });
            saveDataToStorage();
            showToast(`已添加 ${data.length} 道题`, 'success');
            backToMain();
            switchMainTab('banks');
        } catch (e) {
            document.getElementById('bank-error').textContent = 'JSON错误: ' + e.message;
        }
    }

    function deleteBank(id) {
        if (confirm('确定删除这套题库？')) {
            banks = banks.filter(b => b.id !== id);
            saveDataToStorage();
            renderBanks();
            renderBankSelect();
        }
    }

    function exportBank(id) {
        const bank = banks.find(b => b.id === id);
        if (bank) {
            navigator.clipboard.writeText(JSON.stringify(bank.questions, null, 2)).then(() => showToast('已复制 JSON', 'success'));
        }
    }

    function startQuizFromBank() {
        const bankId = document.getElementById('quiz-bank-select').value;
        if (!bankId) { showToast('请选择题库', 'error'); return; }
        startQuizFromBankId(bankId);
    }

    function startQuizFromBankId(bankId) {
        const bank = banks.find(b => b.id === bankId);
        if (!bank) { showToast('题库不存在', 'error'); return; }
        
        currentQuizBankId = bankId;
        quizQuestions = addTagsToQuestions([...bank.questions]);
        
        const shouldShuffle = document.getElementById('shuffle-checkbox').checked;
        timerEnabled = document.getElementById('timer-checkbox').checked;
        
        if (shouldShuffle) quizQuestions = shuffleArray(quizQuestions);
        
        lastQuizJSON = JSON.stringify(bank.questions);
        quizIndex = 0; quizScore = 0; quizMistakes = [];
        
        showView('view-quiz');
        startTimer();
        renderQuizQuestion();
    }

    // ========== 搜索 ==========
    function handleSearch() { searchQuery = document.getElementById('search-input').value.trim().toLowerCase(); renderLibrary(); updateFilterInfo(); }
    function clearSearch() { document.getElementById('search-input').value = ''; searchQuery = ''; renderLibrary(); updateFilterInfo(); }
    function clearAllFilters() { clearSearch(); clearTagFilter(); }
    function updateFilterInfo() {
        const hasFilter = searchQuery || currentTagFilter;
        document.getElementById('filter-info').classList.toggle('hidden', !hasFilter);
        let text = '筛选: ';
        if (currentTagFilter) text += `[${currentTagFilter}] `;
        if (searchQuery) text += `"${searchQuery}" `;
        document.getElementById('filter-text').textContent = text;
    }

    // ========== 合并 ==========
    function toggleMergeMode() {
        mergeMode = !mergeMode; selectedForMerge.clear();
        document.getElementById('merge-btn').textContent = mergeMode ? '取消合并' : '合并模式';
        document.getElementById('merge-toolbar').classList.toggle('hidden', !mergeMode);
        renderLibrary();
    }
    function toggleBookSelection(id) {
        if (selectedForMerge.has(id)) selectedForMerge.delete(id);
        else selectedForMerge.add(id);
        document.getElementById('merge-count').textContent = selectedForMerge.size;
        renderLibrary();
    }
    function cancelMerge() {
        mergeMode = false; selectedForMerge.clear();
        document.getElementById('merge-btn').textContent = '合并模式';
        document.getElementById('merge-toolbar').classList.add('hidden');
        renderLibrary();
    }
    function executeMerge() {
        if (selectedForMerge.size < 2) { alert('请至少选择两个'); return; }
        const name = prompt('请输入合并后的名称:');
        if (!name) return;
        const selectedBooks = books.filter(b => selectedForMerge.has(b.id));
        const allMistakes = [], allSolved = [];
        selectedBooks.forEach(book => {
            book.mistakes.forEach(q => { if (!allMistakes.some(m => m.question === q.question)) allMistakes.push(q); });
            (book.solved || []).forEach(q => { if (!allSolved.some(m => m.question === q.question)) allSolved.push(q); });
        });
        books = books.filter(b => !selectedForMerge.has(b.id));
        books.push({ id: Date.now().toString(), name, mistakes: allMistakes, solved: allSolved });
        saveDataToStorage(); cancelMerge();
        showToast(`已合并为 ${allMistakes.length} 道错题`, 'success');
    }

    // ========== 统计 ==========
    function renderStats() {
        let totalMistakes = 0, totalSolved = 0, totalStarred = 0;
        const tagCounts = {};
        const allMistakes = [];
        
        books.forEach(book => {
            totalMistakes += book.mistakes.length;
            totalSolved += (book.solved || []).length;
            book.mistakes.forEach(q => {
                if (q.starred) totalStarred++;
                (q.tags || []).forEach(t => tagCounts[t] = (tagCounts[t] || 0) + 1);
                allMistakes.push(q);
            });
        });
        
        document.getElementById('stat-total-banks').textContent = banks.length;
        document.getElementById('stat-total-mistakes').textContent = totalMistakes;
        document.getElementById('stat-total-solved').textContent = totalSolved;
        document.getElementById('stat-total-starred').textContent = totalStarred;
        
        const tagContainer = document.getElementById('tag-stats-container');
        const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);
        const maxCount = sortedTags.length > 0 ? sortedTags[0][1] : 1;
        
        tagContainer.innerHTML = sortedTags.length === 0 
            ? '<p style="color: var(--text-light); text-align: center;">暂无数据</p>'
            : sortedTags.slice(0, 15).map(([tag, count]) => `
                <div class="tag-stat-row">
                    <span class="tag-stat-name">${tag}</span>
                    <div class="tag-stat-bar"><div class="tag-stat-fill" style="width: ${count / maxCount * 100}%"></div></div>
                    <span class="tag-stat-count">${count} 题</span>
                </div>
            `).join('');
        
        const frequentContainer = document.getElementById('frequent-mistakes-container');
        const sortedByError = allMistakes.filter(q => q.errorCount > 1).sort((a, b) => b.errorCount - a.errorCount);
        
        frequentContainer.innerHTML = sortedByError.length === 0
            ? '<p style="color: var(--text-light); text-align: center;">暂无重复错题</p>'
            : sortedByError.slice(0, 5).map((q, i) => `
                <div style="padding: 12px; background: var(--card-bg); border-radius: 8px; margin-bottom: 10px;">
                    <span style="font-size: 13px;">${i + 1}. ${q.question.substring(0, 60)}...</span>
                    <span class="error-badge">${q.errorCount} 次</span>
                </div>
            `).join('');
    }

    // ========== 标签 ==========
    function renderLibraryTags() {
        const allTags = new Set();
        books.forEach(book => book.mistakes.forEach(q => (q.tags || []).forEach(t => allTags.add(t))));
        document.getElementById('library-tags').innerHTML = allTags.size === 0 
            ? '<span style="color: var(--text-light);">暂无</span>'
            : Array.from(allTags).sort().map(tag => `<span class="tag ${getTagClass(tag)} ${currentTagFilter === tag ? 'active' : ''}" onclick="filterByTag('${tag}')">${tag}</span>`).join('');
    }
    function filterByTag(tag) { currentTagFilter = currentTagFilter === tag ? null : tag; renderLibraryTags(); renderLibrary(); updateFilterInfo(); }
    function clearTagFilter() { currentTagFilter = null; renderLibraryTags(); renderLibrary(); updateFilterInfo(); }

    // ========== 错题本 ==========
    function renderLibrary() {
        const container = document.getElementById('library-container');
        let filteredBooks = books;
        if (currentTagFilter) filteredBooks = filteredBooks.filter(book => book.mistakes.some(q => (q.tags || []).includes(currentTagFilter)));
        if (searchQuery) filteredBooks = filteredBooks.filter(book => book.name.toLowerCase().includes(searchQuery) || book.mistakes.some(q => q.question.toLowerCase().includes(searchQuery)));
        document.getElementById('total-books').textContent = books.length;

        if (filteredBooks.length === 0) {
            container.innerHTML = `<div class="empty-state"><p>${(currentTagFilter || searchQuery) ? '没有匹配' : '还没有错题本'}</p></div>`;
            return;
        }

        const grid = document.createElement('div');
        grid.className = 'library-grid';
        filteredBooks.forEach(book => {
            const card = document.createElement('div');
            card.className = 'book-card';
            const bookTags = getAllUsedTags(book.mistakes).slice(0, 3);
            const starredCount = book.mistakes.filter(q => q.starred).length;
            
            card.innerHTML = `
                ${mergeMode ? `<div class="merge-checkbox"><input type="checkbox" ${selectedForMerge.has(book.id) ? 'checked' : ''} onclick="event.stopPropagation(); toggleBookSelection('${book.id}')"></div>` : ''}
                <div>
                    <div class="book-title">${book.name}</div>
                    <div class="book-stats">
                        待攻克: <strong style="color:var(--wrong-color)">${book.mistakes.length}</strong><br>
                        已斩杀: <strong style="color:var(--correct-color)">${(book.solved || []).length}</strong>
                        ${starredCount > 0 ? `<br>收藏: <strong style="color:var(--star-color)">${starredCount}</strong>` : ''}
                    </div>
                    ${bookTags.length > 0 ? `<div class="question-tags">${bookTags.map(t => `<span class="question-tag">${t}</span>`).join('')}</div>` : ''}
                </div>
                <div class="book-actions">
                    <button class="small" onclick="openBook('${book.id}')">打开</button>
                    <button class="small danger" onclick="deleteBook('${book.id}', event)">删除</button>
                </div>
            `;
            grid.appendChild(card);
        });
        container.innerHTML = '';
        container.appendChild(grid);
    }

    function showImportView() {
        document.getElementById('set-name-input').value = '';
        document.getElementById('import-json-input').value = '';
        document.getElementById('import-error').textContent = '';
        showView('view-import');
    }

    function saveNewBook() {
        const name = document.getElementById('set-name-input').value.trim();
        const jsonStr = document.getElementById('import-json-input').value;
        if (!name) { document.getElementById('import-error').textContent = '请输入名称'; return; }
        try {
            let data = JSON.parse(jsonStr);
            if (!Array.isArray(data)) throw new Error('必须是数组');
            data = addTagsToQuestions(data);
            books.push({ id: Date.now().toString(), name, mistakes: data, solved: [] });
            saveDataToStorage();
            backToMain(); switchMainTab('library');
        } catch (e) { document.getElementById('import-error').textContent = 'JSON错误: ' + e.message; }
    }

    function deleteBook(id, event) {
        event.stopPropagation();
        if (confirm('确定删除？')) { books = books.filter(b => b.id !== id); saveDataToStorage(); renderLibrary(); renderLibraryTags(); }
    }

    function openBook(id) {
        currentBookId = id;
        const book = getCurrentBook();
        if (!book) return;
        document.getElementById('book-title-display').textContent = book.name;
        document.getElementById('book-remaining').textContent = book.mistakes.length;
        document.getElementById('book-solved').textContent = (book.solved || []).length;
        document.getElementById('book-starred').textContent = book.mistakes.filter(q => q.starred).length;
        document.getElementById('book-tags').innerHTML = getAllUsedTags(book.mistakes).map(t => `<span class="tag ${getTagClass(t)}">${t}</span>`).join('') || '<span style="color: var(--text-light);">暂无</span>';
        showView('view-book');
    }

    function getCurrentBook() { return books.find(b => b.id === currentBookId); }
    function backToBook() { openBook(currentBookId); }
    function exportBook() {
        const book = getCurrentBook();
        navigator.clipboard.writeText(JSON.stringify(book.mistakes, null, 2)).then(() => showToast('已复制 JSON', 'success'));
    }
    function toggleStar(questionIndex) {
        const book = getCurrentBook();
        book.mistakes[questionIndex].starred = !book.mistakes[questionIndex].starred;
        saveDataToStorage(); renderReviewList();
    }
    function saveNote(questionIndex, note) {
        const book = getCurrentBook();
        book.mistakes[questionIndex].note = note;
        saveDataToStorage();
    }

    // ========== 错题重做 ==========
    function startRedo() {
        const book = getCurrentBook();
        if (book.mistakes.length === 0) { alert('没有错题'); return; }
        redoMode = 'all'; redoOriginalCount = book.mistakes.length;
        renderRedoQuestion(); showView('view-redo');
    }
    function startRedoStarred() {
        const book = getCurrentBook();
        const count = book.mistakes.filter(q => q.starred).length;
        if (count === 0) { alert('没有收藏'); return; }
        redoMode = 'starred'; redoOriginalCount = count;
        renderRedoQuestion(); showView('view-redo');
    }
    function getRedoQuestions() {
        const book = getCurrentBook();
        return redoMode === 'starred' ? book.mistakes.filter(q => q.starred) : book.mistakes;
    }
    function renderRedoQuestion() {
        const book = getCurrentBook();
        const questions = getRedoQuestions();
        if (questions.length === 0) { alert('完成'); backToBook(); return; }
        const q = questions[0];
        const qIndex = book.mistakes.indexOf(q);
        document.getElementById('redo-count').textContent = questions.length;
        document.getElementById('redo-progress-bar').style.width = ((redoOriginalCount - questions.length) / redoOriginalCount * 100) + '%';
        document.getElementById('redo-content').innerHTML = `
            <div style="position: relative;">
                <button class="star-btn ${q.starred ? 'starred' : ''}" onclick="toggleRedoStar(${qIndex})">*</button>
                <h2 style="text-align:left; font-size:1.15em; line-height:1.6; padding-right: 40px;">${q.question} ${q.errorCount > 1 ? `<span class="error-badge">${q.errorCount}次</span>` : ''}</h2>
            </div>
            ${(q.tags || []).length > 0 ? `<div class="question-tags">${q.tags.map(t => `<span class="question-tag">${t}</span>`).join('')}</div>` : ''}
            <div style="margin-top: 20px;">${q.options.map(opt => `<label class="option-label" onclick="selectRedoOption(this)"><input type="radio" name="redo-opt" value="${opt.replace(/"/g, '&quot;')}"><span>${opt}</span></label>`).join('')}</div>
        `;
        document.getElementById('redo-submit-btn').classList.remove('hidden');
        document.getElementById('redo-next-btn').classList.add('hidden');
        document.getElementById('redo-feedback').style.display = 'none';
        document.getElementById('redo-feedback').className = 'feedback-box';
    }
    window.toggleRedoStar = function(index) {
        const book = getCurrentBook();
        book.mistakes[index].starred = !book.mistakes[index].starred;
        saveDataToStorage(); renderRedoQuestion();
    };
    window.selectRedoOption = function(label) {
        document.querySelectorAll('#redo-content .option-label').forEach(l => l.classList.remove('selected'));
        label.classList.add('selected'); label.querySelector('input').checked = true;
    };
    function checkRedo() {
        const selected = document.querySelector('input[name="redo-opt"]:checked');
        if (!selected) { alert('请选择'); return; }
        const book = getCurrentBook();
        const questions = getRedoQuestions();
        const q = questions[0];
        const qIndex = book.mistakes.indexOf(q);
        const isCorrect = selected.value === q.answer;
        const fb = document.getElementById('redo-feedback');
        document.getElementById('redo-submit-btn').classList.add('hidden');
        document.getElementById('redo-next-btn').classList.remove('hidden');
        fb.style.display = 'block';
        if (isCorrect) {
            fb.classList.add('feedback-correct'); fb.innerHTML = '<strong>正确</strong>';
            if (!book.solved) book.solved = [];
            book.solved.push(q); book.mistakes.splice(qIndex, 1);
        } else {
            fb.classList.add('feedback-wrong'); fb.innerHTML = `<strong>错误</strong><br>正确答案: ${q.answer}`;
            book.mistakes[qIndex].errorCount = (book.mistakes[qIndex].errorCount || 0) + 1;
            const wrongQ = book.mistakes.splice(qIndex, 1)[0];
            book.mistakes.push(wrongQ);
        }
        saveDataToStorage();
    }
    function nextRedo() { renderRedoQuestion(); }

    // ========== 错题回顾 ==========
    function startReview() {
        const book = getCurrentBook();
        if (book.mistakes.length === 0) { alert('没有错题'); return; }
        reviewMode = 'all'; document.getElementById('review-mode-title').textContent = '回顾模式';
        reviewTagFilter = null; renderReviewTags(); renderReviewList(); showView('view-review');
    }
    function startStarredReview() {
        const book = getCurrentBook();
        if (book.mistakes.filter(q => q.starred).length === 0) { alert('没有收藏'); return; }
        reviewMode = 'starred'; document.getElementById('review-mode-title').textContent = '收藏回顾';
        reviewTagFilter = null; renderReviewTags(); renderReviewList(); showView('view-review');
    }
    function renderReviewTags() {
        const book = getCurrentBook();
        let questions = reviewMode === 'starred' ? book.mistakes.filter(q => q.starred) : book.mistakes;
        const allTags = getAllUsedTags(questions);
        document.getElementById('review-tags').innerHTML = allTags.length > 0
            ? allTags.map(t => `<span class="tag ${getTagClass(t)} ${reviewTagFilter === t ? 'active' : ''}" onclick="filterReviewByTag('${t}')">${t}</span>`).join('')
            : '<span style="color: var(--text-light);">暂无</span>';
    }
    window.filterReviewByTag = function(tag) {
        reviewTagFilter = reviewTagFilter === tag ? null : tag;
        renderReviewTags(); renderReviewList();
        if (reviewTagFilter) {
            const book = getCurrentBook();
            let questions = reviewMode === 'starred' ? book.mistakes.filter(q => q.starred) : book.mistakes;
            const count = questions.filter(q => (q.tags || []).includes(tag)).length;
            document.getElementById('review-filter-info').classList.remove('hidden');
            document.getElementById('review-filter-text').textContent = `${tag} (${count}题)`;
        } else { document.getElementById('review-filter-info').classList.add('hidden'); }
    };
    function clearReviewTagFilter() {
        reviewTagFilter = null; renderReviewTags(); renderReviewList();
        document.getElementById('review-filter-info').classList.add('hidden');
    }
    function renderReviewList() {
        const book = getCurrentBook();
        const list = document.getElementById('review-list');
        let questions = reviewMode === 'starred' ? book.mistakes.filter(q => q.starred) : book.mistakes;
        if (reviewTagFilter) questions = questions.filter(q => (q.tags || []).includes(reviewTagFilter));
        if (questions.length === 0) { list.innerHTML = '<div class="empty-state"><p>没有题目</p></div>'; return; }
        list.innerHTML = '';
        questions.forEach(q => {
            const qIndex = book.mistakes.indexOf(q);
            const item = document.createElement('div');
            item.className = `review-item ${q.starred ? 'starred' : ''}`;
            item.innerHTML = `
                <button class="star-btn ${q.starred ? 'starred' : ''}" onclick="toggleStar(${qIndex})">*</button>
                ${(q.tags || []).length > 0 ? `<div class="question-tags" style="margin-bottom: 10px;">${q.tags.map(t => `<span class="question-tag">${t}</span>`).join('')}</div>` : ''}
                <div style="font-weight:500; margin-bottom:12px; line-height:1.6; padding-right: 40px;">${q.question} ${q.errorCount > 1 ? `<span class="error-badge">${q.errorCount}次</span>` : ''}</div>
                <div style="color:var(--text-light); font-size:0.92em; line-height:1.7;">${q.options.map(o => `<div>- ${o}</div>`).join('')}</div>
                <div style="border-top:1px solid var(--border-color); margin-top:12px; padding-top:12px;">
                    ${q.user_wrong_choice ? `<div style="color:var(--wrong-color); margin-bottom:5px;">曾选: ${q.user_wrong_choice}</div>` : ''}
                    <div style="color:var(--correct-color);">正确: <strong>${q.answer}</strong></div>
                </div>
                <div class="note-section">${q.note ? `<div class="note-display">${q.note}</div>` : `<textarea class="note-input" placeholder="添加笔记..." onchange="saveNote(${qIndex}, this.value)"></textarea>`}</div>
            `;
            list.appendChild(item);
        });
    }

    // ========== 刷题 ==========
    function startQuiz() {
        const input = document.getElementById('quiz-json-input').value;
        const shouldShuffle = document.getElementById('shuffle-checkbox').checked;
        timerEnabled = document.getElementById('timer-checkbox').checked;
        try {
            if (!input.trim()) throw new Error('请输入数据');
            quizQuestions = JSON.parse(input);
            if (!Array.isArray(quizQuestions) || quizQuestions.length === 0) throw new Error('必须是非空数组');
            if (!quizQuestions[0].question || !quizQuestions[0].answer) throw new Error('格式错误');
            quizQuestions = addTagsToQuestions(quizQuestions);
            if (shouldShuffle) quizQuestions = shuffleArray(quizQuestions);
            lastQuizJSON = input; currentQuizBankId = null;
            quizIndex = 0; quizScore = 0; quizMistakes = [];
            showView('view-quiz'); startTimer(); renderQuizQuestion();
        } catch (e) { document.getElementById('quiz-error').textContent = e.message; }
    }

    function renderQuizQuestion() {
        const q = quizQuestions[quizIndex];
        quizAnswered = false;
        document.getElementById('quiz-progress').textContent = `${quizIndex + 1} / ${quizQuestions.length}`;
        document.getElementById('question-text').textContent = q.question;
        document.getElementById('quiz-progress-bar').style.width = (quizIndex / quizQuestions.length * 100) + '%';
        document.getElementById('question-tags-display').innerHTML = (q.tags || []).map(t => `<span class="question-tag">${t}</span>`).join('');
        document.getElementById('quiz-submit-btn').classList.remove('hidden');
        document.getElementById('quiz-next-btn').classList.add('hidden');
        document.getElementById('quiz-feedback').style.display = 'none';
        document.getElementById('quiz-feedback').className = 'feedback-box';
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        q.options.forEach(opt => {
            const label = document.createElement('label');
            label.className = 'option-label';
            label.innerHTML = `<input type="radio" name="quiz-opt" value="${opt.replace(/"/g, '&quot;')}"><span>${opt}</span>`;
            label.querySelector('input').addEventListener('change', () => {
                document.querySelectorAll('#options-container .option-label').forEach(l => l.classList.remove('selected'));
                label.classList.add('selected');
            });
            container.appendChild(label);
        });
    }

    function checkQuizAnswer() {
        if (quizAnswered) return;
        const selected = document.querySelector('input[name="quiz-opt"]:checked');
        if (!selected) { alert('请选择'); return; }
        quizAnswered = true;
        const userVal = selected.value;
        const correctVal = quizQuestions[quizIndex].answer;
        const fb = document.getElementById('quiz-feedback');
        document.getElementById('quiz-submit-btn').classList.add('hidden');
        document.getElementById('quiz-next-btn').classList.remove('hidden');
        fb.style.display = 'block';
        if (userVal === correctVal) {
            quizScore++; document.getElementById('quiz-score').textContent = quizScore;
            fb.classList.add('feedback-correct'); fb.innerHTML = '<strong>正确</strong>';
        } else {
            fb.classList.add('feedback-wrong'); fb.innerHTML = `<strong>错误</strong><br>正确答案: ${correctVal}`;
            quizMistakes.push({ ...quizQuestions[quizIndex], user_wrong_choice: userVal, errorCount: 1 });
        }
    }

    function nextQuizQuestion() {
        quizIndex++;
        if (quizIndex < quizQuestions.length) renderQuizQuestion();
        else showQuizResults();
    }

    function confirmExitQuiz() { if (confirm('确定退出？')) { stopTimer(); backToMain(); } }

    function showQuizResults() {
        stopTimer();
        document.getElementById('final-score').textContent = quizScore;
        document.getElementById('final-total').textContent = quizQuestions.length;
        document.getElementById('accuracy-rate').textContent = Math.round(quizScore / quizQuestions.length * 100);
        document.getElementById('total-time').textContent = formatTime(timerSeconds);
        document.getElementById('quiz-progress-bar').style.width = '100%';
        if (quizMistakes.length > 0) {
            document.getElementById('quiz-result-mistakes').classList.remove('hidden');
            document.getElementById('quiz-result-perfect').classList.add('hidden');
            document.getElementById('quiz-mistake-json').value = JSON.stringify(quizMistakes, null, 2);
            autoAddToMistakeBook();
        } else {
            document.getElementById('quiz-result-mistakes').classList.add('hidden');
            document.getElementById('quiz-result-perfect').classList.remove('hidden');
        }
        showView('view-quiz-result');
    }

    function autoAddToMistakeBook() {
        let autoBook = books.find(b => b.name === '刷题错题');
        if (!autoBook) { autoBook = { id: 'auto_' + Date.now(), name: '刷题错题', mistakes: [], solved: [] }; books.push(autoBook); }
        quizMistakes.forEach(m => {
            const idx = autoBook.mistakes.findIndex(x => x.question === m.question);
            if (idx >= 0) { autoBook.mistakes[idx].errorCount = (autoBook.mistakes[idx].errorCount || 0) + 1; autoBook.mistakes[idx].user_wrong_choice = m.user_wrong_choice; }
            else { autoBook.mistakes.push(m); }
        });
        saveDataToStorage();
    }

    function copyQuizMistakes() { navigator.clipboard.writeText(document.getElementById('quiz-mistake-json').value).then(() => showToast('已复制', 'success')); }

    function restartQuiz() {
        if (currentQuizBankId) { startQuizFromBankId(currentQuizBankId); }
        else { document.getElementById('quiz-json-input').value = lastQuizJSON; backToMain(); startQuiz(); }
    }
</script>

</body>
</html>
